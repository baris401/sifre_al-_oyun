<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Şifre Ustası: Sınıf Yarışması (AI Powered)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Rubik:wght@400;600;800&display=swap" rel="stylesheet">
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        body {
            font-family: 'Rubik', sans-serif;
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
            color: white;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            touch-action: manipulation;
        }

        .title-font { font-family: 'Righteous', cursive; }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .game-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
        }

        .char-box { perspective: 1000px; }
        .char-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
            width: 100%; height: 100%;
        }
        .char-box.revealed .char-inner { transform: rotateY(180deg); }
        .char-front, .char-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; display: flex;
            align-items: center; justify-content: center;
            border-radius: 0.5rem;
        }
        .char-front { background-color: #334155; border: 2px solid #475569; }
        .char-back { 
            background: linear-gradient(135deg, #2563eb, #7c3aed); 
            transform: rotateY(180deg);
            color: white; font-weight: bold;
            border: 2px solid #60a5fa;
        }

        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .answer-btn {
            background: white; color: #1e293b;
            border-bottom: 4px solid #cbd5e1;
            transition: all 0.1s;
        }
        .answer-btn:active { transform: translateY(2px); border-bottom-width: 0; }
        .answer-btn.correct {
            background: #22c55e; color: white; border-color: #15803d;
            pointer-events: none; opacity: 0.9; border-bottom-width: 0; transform: translateY(2px);
        }
        .answer-btn.wrong {
            background: #ef4444; color: white; border-color: #b91c1c;
        }

        .confetti { position: fixed; width: 10px; height: 10px; z-index: 100; pointer-events: none; }
        
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* AI Gradient Text */
        .text-gradient-ai {
            background: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-0 md:p-4">

    <!-- 1. KATEGORİ SEÇİM EKRANI (Öğretmen/Yönetici Paneli) -->
    <div id="categoryScreen" class="w-full max-w-md text-center p-6 h-full flex flex-col justify-center fade-in z-50">
        <div class="space-y-4 mb-6">
            <div class="inline-block p-4 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg animate-bounce">
                <i class="fas fa-shapes text-5xl text-white"></i>
            </div>
            <h1 class="text-4xl title-font text-white">OYUN KURULUMU</h1>
            <p class="text-gray-400">Sınıf düzeyini seçin veya AI ile oluşturun.</p>
        </div>

        <div class="game-card p-4 rounded-2xl space-y-3 flex-1 overflow-y-auto max-h-[65vh]">
            <!-- AI BUTTON -->
            <button onclick="openAIModal()" class="w-full group flex items-center p-4 rounded-xl bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 border border-blue-400 transition transform hover:scale-[1.02] shadow-lg shadow-blue-500/20">
                <div class="bg-white/20 w-12 h-12 flex items-center justify-center rounded-lg mr-4 text-white"><i class="fas fa-magic text-xl"></i></div>
                <div class="text-left flex-1">
                    <div class="font-bold text-white text-lg">✨ Yapay Zeka Modu</div>
                    <div class="text-xs text-blue-100">İstediğin konuda soru üret!</div>
                </div>
                <i class="fas fa-sparkles text-white animate-pulse"></i>
            </button>

            <div class="h-px bg-slate-600/50 my-2"></div>

            <button onclick="setCategory('ilkokul')" class="w-full group flex items-center p-4 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition btn-hover">
                <div class="bg-green-500/20 w-12 h-12 flex items-center justify-center rounded-lg mr-4 text-green-400"><i class="fas fa-child text-xl"></i></div>
                <div class="text-left flex-1">
                    <div class="font-bold text-white text-lg">İlkokul Modu</div>
                    <div class="text-xs text-gray-400">Temel Bilgiler</div>
                </div>
                <i class="fas fa-chevron-right text-gray-600"></i>
            </button>

            <button onclick="setCategory('ortaokul')" class="w-full group flex items-center p-4 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition btn-hover">
                <div class="bg-blue-500/20 w-12 h-12 flex items-center justify-center rounded-lg mr-4 text-blue-400"><i class="fas fa-school text-xl"></i></div>
                <div class="text-left flex-1">
                    <div class="font-bold text-white text-lg">Ortaokul Modu</div>
                    <div class="text-xs text-gray-400">Fen, Sosyal, Genel</div>
                </div>
                <i class="fas fa-chevron-right text-gray-600"></i>
            </button>

            <button onclick="setCategory('lgs')" class="w-full group flex items-center p-4 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition btn-hover">
                <div class="bg-purple-500/20 w-12 h-12 flex items-center justify-center rounded-lg mr-4 text-purple-400"><i class="fas fa-brain text-xl"></i></div>
                <div class="text-left flex-1">
                    <div class="font-bold text-white text-lg">LGS (8. Sınıf)</div>
                    <div class="text-xs text-gray-400">Sınav Müfredatı</div>
                </div>
                <i class="fas fa-chevron-right text-gray-600"></i>
            </button>
            
             <button onclick="showLeaderboard('all')" class="w-full mt-4 bg-yellow-500/10 border border-yellow-500/50 p-3 rounded-xl text-yellow-400 font-bold hover:bg-yellow-500/20 transition">
                <i class="fas fa-crown mr-2"></i> Liderlik Tablosu
            </button>
        </div>
    </div>

    <!-- AI PROMPT MODAL -->
    <div id="aiModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden p-4">
        <div class="bg-slate-900 border border-blue-500/50 p-6 rounded-3xl max-w-sm w-full text-center relative shadow-2xl shadow-blue-500/20">
            <button onclick="closeAIModal()" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-full flex items-center justify-center mx-auto mb-4 text-white shadow-lg">
                <i class="fas fa-robot text-3xl"></i>
            </div>
            
            <h2 class="text-2xl font-bold text-white mb-2">Yapay Zeka Oluşturucu</h2>
            <p class="text-gray-400 text-sm mb-6">Hangi konuda soru hazırlamak istersin?</p>

            <input type="text" id="aiTopicInput" placeholder="Örn: Uzay, Mitoz Bölünme, Futbol..." class="w-full bg-slate-800 border border-slate-600 rounded-xl p-4 text-white mb-4 focus:outline-none focus:border-blue-500 placeholder-gray-500 text-center">

            <button onclick="startAIGame()" class="w-full py-3 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-xl font-bold hover:shadow-lg hover:scale-[1.02] transition">
                <i class="fas fa-wand-magic-sparkles mr-2"></i> Oluştur ve Başla
            </button>
        </div>
    </div>

    <!-- 2. ÖĞRENCİ GİRİŞ EKRANI -->
    <div id="loginScreen" class="hidden w-full max-w-md p-6 h-full flex flex-col justify-center items-center fade-in">
        <div class="absolute top-4 left-4">
            <button onclick="backToCategories()" class="text-xs text-gray-500 hover:text-white flex items-center gap-1 bg-slate-800/50 px-3 py-1 rounded-full border border-slate-700">
                <i class="fas fa-cog"></i> Ayarları Değiştir
            </button>
        </div>

        <div class="mb-8 text-center">
            <span id="activeCategoryBadge" class="inline-block px-3 py-1 rounded-full bg-blue-600/20 text-blue-400 text-xs font-bold uppercase tracking-widest border border-blue-600/30 mb-4">
                LGS MODU SEÇİLDİ
            </span>
            <h1 class="text-4xl title-font text-white mb-2">SIRADAKİ YARIŞMACI</h1>
            <p class="text-gray-400">Lütfen ismini gir ve yarışmaya başla</p>
        </div>
        
        <div class="game-card w-full p-6 rounded-2xl relative">
            <div class="absolute -top-6 left-1/2 -translate-x-1/2 w-12 h-12 bg-slate-700 rounded-full flex items-center justify-center border-4 border-slate-800">
                <i class="fas fa-user text-xl text-white"></i>
            </div>
            
            <input type="text" id="studentName" placeholder="Adın Soyadın" class="w-full bg-slate-800 border border-slate-600 rounded-xl p-4 text-white text-lg focus:outline-none focus:border-blue-500 mb-4 text-center placeholder-gray-500 mt-4" autocomplete="off">
            
            <button onclick="startSession()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-blue-500/30 transition transform hover:scale-[1.02] active:scale-95">
                BAŞLA <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <!-- 3. OYUN EKRANI -->
    <div id="gameScreen" class="hidden w-full max-w-4xl flex flex-col h-full max-h-screen">
        
        <!-- Üst Bar -->
        <div class="bg-slate-900/90 p-2 flex justify-between items-center border-b border-slate-700 backdrop-blur-sm z-20">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center text-xs font-bold text-white border border-indigo-400">
                    <i class="fas fa-user"></i>
                </div>
                <span id="gamePlayerName" class="text-sm font-bold text-gray-300 max-w-[100px] truncate">Öğrenci</span>
            </div>
            
            <div class="flex gap-4 text-sm font-mono bg-slate-800 px-3 py-1 rounded-lg border border-slate-700">
                <div class="flex items-center text-blue-400">
                    <i class="fas fa-clock mr-2"></i> <span id="timerDisplay">00:00</span>
                </div>
                <div class="w-px h-4 bg-slate-600"></div>
                <div class="flex items-center text-yellow-400">
                    <i class="fas fa-star mr-2"></i> <span id="scoreDisplay">0</span>
                </div>
            </div>

            <button onclick="toggleSound()" id="soundBtn" class="text-gray-400 hover:text-white px-2">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>

        <!-- Soru Kartı -->
        <div class="relative bg-gradient-to-br from-indigo-900 to-slate-900 m-2 p-4 rounded-xl shadow-xl text-center border border-indigo-500/30 flex-shrink-0 min-h-[120px] md:min-h-[160px] flex flex-col justify-center">
            <span class="absolute top-2 left-2 text-[10px] uppercase font-bold text-indigo-400 tracking-wider bg-black/20 px-2 py-0.5 rounded">Soru <span id="qIndex">1</span></span>
            <h2 id="questionText" class="text-lg md:text-3xl font-bold leading-tight mt-2 px-2 drop-shadow-lg">Soru Yükleniyor...</h2>
        </div>

        <!-- Cevap Izgarası -->
        <div class="flex-1 overflow-y-auto px-2 w-full">
            <div id="answersGrid" class="grid grid-cols-2 md:grid-cols-4 gap-2 pb-2">
                <!-- Butonlar JS ile -->
            </div>
        </div>

        <!-- Alt Panel: Şifre -->
        <div class="bg-slate-800 p-3 flex-shrink-0 border-t-4 border-indigo-500 shadow-[0_-10px_30px_rgba(0,0,0,0.5)] z-10">
            <div class="text-center mb-2">
                <span class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.3em]">ŞİFREYİ ÇÖZ</span>
            </div>
            <div id="passwordContainer" class="flex flex-wrap justify-center gap-1">
                <!-- Harfler JS ile -->
            </div>
        </div>
    </div>

    <!-- 4. SONUÇ MODALI -->
    <div id="resultModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-sm hidden p-4">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-3xl max-w-sm w-full text-center relative overflow-hidden shadow-2xl fade-in">
            <div class="absolute top-0 w-full h-1 bg-gradient-to-r from-green-400 to-blue-500"></div>
            
            <div class="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4 text-green-400 ring-4 ring-green-500/10">
                <i class="fas fa-flag-checkered text-3xl"></i>
            </div>
            
            <h2 class="text-3xl font-black text-white mb-1">TEBRİKLER!</h2>
            <p class="text-gray-400 text-sm mb-4"><span id="resultPlayerName" class="text-white font-bold">Ali</span>, harika bir iş çıkardın.</p>

            <div class="bg-slate-800 rounded-xl p-4 mb-4 grid grid-cols-2 gap-4">
                <div>
                    <p class="text-xs text-gray-500 uppercase">Puan</p>
                    <p id="finalScore" class="text-2xl font-bold text-yellow-400">0</p>
                </div>
                <div>
                    <p class="text-xs text-gray-500 uppercase">Süre</p>
                    <p id="finalTime" class="text-2xl font-bold text-blue-400">00:00</p>
                </div>
                <div class="col-span-2 border-t border-slate-700 pt-2 bg-slate-700/30 rounded-b-lg -mx-4 -mb-4 pb-2">
                     <p class="text-xs text-gray-500 uppercase mt-2">Gizli Şifre</p>
                     <p id="finalPassword" class="text-xl font-bold text-indigo-400 tracking-widest">AFERİN</p>
                </div>
            </div>

            <button onclick="resetForNewStudent()" class="w-full py-4 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-xl font-bold hover:shadow-lg hover:shadow-indigo-500/30 transition transform hover:scale-[1.02]">
                <i class="fas fa-user-plus mr-2"></i> Sıradaki Öğrenci Gelsin
            </button>
            <button onclick="showLeaderboard('current')" class="mt-3 text-xs text-gray-400 hover:text-white underline">Sıralamayı Gör</button>
        </div>
    </div>

    <!-- 5. LİDERLİK TABLOSU -->
    <div id="leaderboardModal" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/95 hidden backdrop-blur-md">
        <div class="w-full h-full md:max-w-2xl md:h-[80vh] bg-slate-900 md:bg-slate-800 md:border md:border-slate-700 md:rounded-3xl flex flex-col relative shadow-2xl">
            
            <div class="p-6 pb-2 border-b border-slate-700">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-black text-white italic"><i class="fas fa-trophy text-yellow-500 mr-2"></i> LİDERLER</h2>
                    <button onclick="closeLeaderboard()" class="w-8 h-8 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center transition text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                    <button onclick="filterLeaderboard('all')" class="lb-filter px-4 py-1 rounded-full bg-blue-600 text-white text-xs font-bold">Genel</button>
                    <button onclick="filterLeaderboard('ilkokul')" class="lb-filter px-4 py-1 rounded-full bg-slate-700 text-gray-300 text-xs font-bold">İlkokul</button>
                    <button onclick="filterLeaderboard('ortaokul')" class="lb-filter px-4 py-1 rounded-full bg-slate-700 text-gray-300 text-xs font-bold">Ortaokul</button>
                    <button onclick="filterLeaderboard('lgs')" class="lb-filter px-4 py-1 rounded-full bg-slate-700 text-gray-300 text-xs font-bold">LGS</button>
                    <button onclick="filterLeaderboard('ai')" class="lb-filter px-4 py-1 rounded-full bg-gradient-to-r from-blue-500 to-cyan-400 text-white text-xs font-bold">Yapay Zeka</button>
                </div>
            </div>

            <div class="grid grid-cols-12 px-6 py-2 text-xs font-bold text-gray-500 uppercase bg-slate-900/50">
                <div class="col-span-1">#</div>
                <div class="col-span-5">Öğrenci</div>
                <div class="col-span-3 text-right">Puan</div>
                <div class="col-span-3 text-right">Süre</div>
            </div>

            <div id="leaderboardList" class="flex-1 overflow-y-auto px-4 py-2 space-y-1 bg-slate-900/30"></div>
            
            <div class="p-4 text-center border-t border-slate-700">
                 <button onclick="clearLeaderboard()" class="text-xs text-red-400 hover:text-red-300 opacity-60 hover:opacity-100 transition"><i class="fas fa-trash mr-1"></i> Listeyi Temizle</button>
            </div>
        </div>
    </div>

    <!-- Yükleniyor Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-slate-900 z-[100] hidden flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-500 border-t-transparent mb-4"></div>
        <p id="loadingText" class="text-blue-400 font-bold tracking-widest animate-pulse">HAZIRLANIYOR...</p>
    </div>

    <script>
        const apiKey = ""; // Runtime Environment will provide this

        // --- VERİ HAVUZU (Fallback) ---
        const passwords = ["BAŞARI", "AZİM", "BİLGİ", "ZEKA", "HEDEF", "KİTAP", "BİLİM", "SANAT", "SPOR", "SAYGI"];

        const questionsDB = {
            ilkokul: [
                {q: "Türkiye'nin başkenti?", a: "Ankara"}, {q: "Bir yılda kaç mevsim var?", a: "4"},
                {q: "29 Ekim'de ne kutlanır?", a: "Cumhuriyet"}, {q: "Alfabenin ilk harfi?", a: "A"},
                {q: "Kırmızı + Beyaz = ?", a: "Pembe"}, {q: "Dünyanın şekli?", a: "Küre"},
                {q: "1 düzine kaçtır?", a: "12"}, {q: "İstiklal Marşı şairi?", a: "M. Akif"}
            ],
            ortaokul: [
                {q: "Suyun formülü?", a: "H2O"}, {q: "İstanbul'un Fethi?", a: "1453"},
                {q: "Maddenin en sıcak hali?", a: "Plazma"}, {q: "En yüksek dağımız?", a: "Ağrı"},
                {q: "Işığı geçirmeyen?", a: "Opak"}, {q: "Elma (İngilizce)?", a: "Apple"}
            ],
            lgs: [
                {q: "DNA yapı birimi?", a: "Nükleotid"}, {q: "Fiilimsi sayısı?", a: "3"},
                {q: "Mustafa Kemal'in rütbesi (Sakarya)?", a: "Mareşal"}, {q: "8A grubu?", a: "Soygaz"},
                {q: "Karekök 144?", a: "12"}, {q: "Basınç birimi?", a: "Pascal"}
            ]
        };

        const distractors = ["5", "Hayır", "Mars", "Paris", "O2", "Karbon", "6", "İzmir", "Güney", "Sıfat", "Hücre", "Atom", "Elips", "Litre", "Newton", "Gaz", "Sıvı", "10", "100", "Lozan", "Sevr", "Mondros"];

        // --- GLOBAL DURUM ---
        let currentLevel = "ilkokul";
        let currentPlayer = "";
        let gameData = [];
        let currentPassword = "";
        let step = 0;
        let score = 0;
        let startTime = 0;
        let timerInterval = null;
        let soundEnabled = true;
        
        // AI Cache
        let aiGeneratedData = null; // Stores { password: "", questions: [] }

        // --- GEMINI API ENTEGRASYONU ---
        async function fetchAIQuestions(topic) {
            const loadingText = document.getElementById('loadingText');
            loadingText.innerText = "YAPAY ZEKA DÜŞÜNÜYOR...";
            document.getElementById('loadingOverlay').classList.remove('hidden');

            const prompt = `
                Sen bir Türk öğretmensin. Aşağıdaki konuda bir kelime (şifre) ve bu kelimenin harf sayısı kadar çoktan seçmeli soru hazırla.
                Konu: "${topic}"
                Format: JSON
                JSON Şeması:
                {
                    "password": "TEK_KELİME_ŞİFRE (Büyük Harf, Türkçe Karakter Kullan)",
                    "questions": [
                        {
                            "q": "Soru metni?",
                            "a": "Doğru Cevap",
                            "d": ["Yanlış1", "Yanlış2", "Yanlış3"]
                        }
                    ]
                }
                Kurallar:
                1. Soru sayısı şifrenin uzunluğuyla aynı olmalı.
                2. Sorular konuyla ilgili olmalı.
                3. Şifre konuyla ilgili anlamlı bir kelime olmalı.
                4. Cevaplar kısa ve net olmalı.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) throw new Error("API Hatası");

                const data = await response.json();
                let text = data.candidates[0].content.parts[0].text;
                
                // Temizleme (JSON markdown bloklarını kaldır)
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                
                const jsonResult = JSON.parse(text);
                
                // Başarılı
                aiGeneratedData = jsonResult;
                return true;

            } catch (error) {
                console.error("Gemini Hatası:", error);
                alert("Yapay zeka şu an meşgul. Lütfen tekrar dene veya hazır kategorilerden seç.");
                document.getElementById('loadingOverlay').classList.add('hidden');
                return false;
            }
        }

        // --- AI UI KONTROLLERİ ---
        function openAIModal() {
            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('aiTopicInput').focus();
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.add('hidden');
        }

        async function startAIGame() {
            const topic = document.getElementById('aiTopicInput').value.trim();
            if (topic.length < 2) {
                alert("Lütfen bir konu girin.");
                return;
            }

            closeAIModal();
            const success = await fetchAIQuestions(topic);
            
            if (success) {
                currentLevel = 'ai'; // Özel seviye işareti
                
                document.getElementById('activeCategoryBadge').innerText = `KONU: ${topic.toUpperCase()}`;
                document.getElementById('activeCategoryBadge').className = "inline-block px-3 py-1 rounded-full bg-cyan-600/20 text-cyan-400 text-xs font-bold uppercase tracking-widest border border-cyan-600/30 mb-4";
                
                document.getElementById('categoryScreen').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loadingOverlay').classList.add('hidden');
                
                document.getElementById('studentName').value = "";
                setTimeout(() => document.getElementById('studentName').focus(), 500);
            }
        }

        // --- AKIŞ KONTROLLERİ ---
        function setCategory(level) {
            currentLevel = level;
            aiGeneratedData = null; // Reset AI data
            
            let badgeText = "BİLİNMEYEN MOD";
            if(level === 'ilkokul') badgeText = "İLKOKUL MODU";
            else if(level === 'ortaokul') badgeText = "ORTAOKUL MODU";
            else if(level === 'lgs') badgeText = "LGS MODU";
            
            document.getElementById('activeCategoryBadge').innerText = badgeText;
            document.getElementById('activeCategoryBadge').className = "inline-block px-3 py-1 rounded-full bg-blue-600/20 text-blue-400 text-xs font-bold uppercase tracking-widest border border-blue-600/30 mb-4";

            document.getElementById('categoryScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            document.getElementById('studentName').value = "";
            setTimeout(() => document.getElementById('studentName').focus(), 500);
        }

        function backToCategories() {
            if(confirm("Yarışma ayarlarını değiştirmek istediğine emin misin?")) {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('categoryScreen').classList.remove('hidden');
            }
        }

        function startSession() {
            const input = document.getElementById('studentName');
            const name = input.value.trim();
            
            if(name.length < 2) {
                shakeElement(input);
                return;
            }
            
            currentPlayer = name;
            document.getElementById('gamePlayerName').innerText = currentPlayer;
            
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('loadingText').innerText = "HAZIRLANIYOR...";
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            setTimeout(initGame, 1000);
        }

        function shakeElement(el) {
            el.classList.add('shake', 'border-red-500');
            setTimeout(() => el.classList.remove('shake', 'border-red-500'), 500);
        }

        // --- OYUN MOTORU ---
        function initGame() {
            if (currentLevel === 'ai' && aiGeneratedData) {
                // AI Verisi Kullan
                currentPassword = aiGeneratedData.password;
                gameData = aiGeneratedData.questions.map((q, i) => ({
                    q: q.q,
                    a: q.a,
                    d: q.d || distractors, // Fallback if AI forgets distractors
                    char: currentPassword[i]
                }));
            } else {
                // Standart Veri Kullan
                currentPassword = passwords[Math.floor(Math.random() * passwords.length)];
                generateSafeQuestions(currentLevel, currentPassword.length);
            }
            
            // UI Sıfırla
            step = 0;
            score = 0;
            updateScoreDisplay();
            renderPasswordBox();
            
            // Ekranı Aç
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            // Başla
            nextQuestion();
            startTimer();
        }

        function generateSafeQuestions(level, count) {
            gameData = [];
            let pool = JSON.parse(JSON.stringify(questionsDB[level]));
            
            for (let i = 0; i < count; i++) {
                if (pool.length === 0) pool = JSON.parse(JSON.stringify(questionsDB[level]));
                
                const randIdx = Math.floor(Math.random() * pool.length);
                const q = pool[randIdx];
                
                gameData.push({ 
                    q: q ? q.q : "Soru Yüklenemedi", 
                    a: q ? q.a : "Cevap Yok", 
                    char: currentPassword[i] 
                });
                
                pool.splice(randIdx, 1);
            }
        }

        function renderPasswordBox() {
            const container = document.getElementById('passwordContainer');
            container.innerHTML = '';
            for (let i = 0; i < currentPassword.length; i++) {
                container.innerHTML += `
                    <div class="char-box w-8 h-10 md:w-10 md:h-12 relative select-none" id="char-${i}">
                        <div class="char-inner">
                            <div class="char-front text-gray-500 font-bold text-lg flex items-center justify-center border border-slate-600 rounded">?</div>
                            <div class="char-back text-lg md:text-xl flex items-center justify-center rounded">${currentPassword[i]}</div>
                        </div>
                    </div>`;
            }
        }

        function nextQuestion() {
            if (step >= gameData.length) {
                endGame();
                return;
            }

            const data = gameData[step];
            document.getElementById('qIndex').innerText = step + 1;
            
            const qText = document.getElementById('questionText');
            qText.style.opacity = 0;
            qText.style.transform = "translateY(5px)";
            
            setTimeout(() => {
                qText.innerText = data.q;
                qText.style.opacity = 1;
                qText.style.transform = "translateY(0)";
                qText.style.transition = "all 0.3s ease-out";
            }, 200);

            // Cevap Şıklarını Hazırla
            let options = [data.a];
            
            // Eğer AI verisi ise, özel distractorları kullan, yoksa genel havuzu kullan
            let wrongs = [];
            if (data.d && Array.isArray(data.d) && data.d.length > 0) {
                wrongs = data.d;
            } else {
                const allAnswers = questionsDB[currentLevel] ? questionsDB[currentLevel].map(x => x.a).concat(distractors) : distractors;
                wrongs = allAnswers.filter(a => a !== data.a);
            }
            
            // 7 tane yanlış ekle (toplam 8)
            let safeWrongs = [...wrongs];
            while (options.length < 8 && safeWrongs.length > 0) {
                const randIndex = Math.floor(Math.random() * safeWrongs.length);
                const w = safeWrongs[randIndex];
                if (!options.includes(w)) options.push(w);
                // Aynı yanlışı tekrar seçmemek için havuzdan silmiyoruz, include kontrolü yetiyor ama loop'a girmesin
                // Aslında sonsuz döngüyü engellemek için safeWrongs bitince durmalı veya tekrar doldurmalı
                // Basit çözüm: eğer yetmiyorsa döngüden çık
                if(options.length < 8 && safeWrongs.every(x => options.includes(x))) break; 
            }
            
            options.sort(() => Math.random() - 0.5);

            const grid = document.getElementById('answersGrid');
            grid.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "answer-btn w-full h-12 md:h-16 rounded-xl font-bold text-xs md:text-sm shadow-sm break-words px-1 hover:brightness-95";
                btn.innerText = opt;
                btn.onclick = () => handleAnswer(btn, opt, data.a);
                grid.appendChild(btn);
            });
        }

        function handleAnswer(btn, selected, correct) {
            if (btn.disabled) return;

            if (selected === correct) {
                playSound('correct');
                btn.classList.add('correct');
                btn.innerHTML = '<i class="fas fa-check text-lg"></i>';
                
                document.getElementById(`char-${step}`).classList.add('revealed');
                
                score += 100;
                step++;
                
                document.querySelectorAll('.answer-btn').forEach(b => b.disabled = true);
                
                updateScoreDisplay();
                setTimeout(nextQuestion, 800);
            } else {
                playSound('error');
                btn.classList.add('wrong', 'shake');
                score = Math.max(0, score - 10);
                updateScoreDisplay();
                setTimeout(() => btn.classList.remove('shake', 'wrong'), 500);
            }
        }

        // --- ZAMANLAYICI ---
        function startTimer() {
            startTime = Date.now();
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const delta = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(delta / 60).toString().padStart(2, '0');
                const s = (delta % 60).toString().padStart(2, '0');
                document.getElementById('timerDisplay').innerText = `${m}:${s}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            return Math.floor((Date.now() - startTime) / 1000);
        }

        function updateScoreDisplay() {
            const el = document.getElementById('scoreDisplay');
            el.innerText = score;
            el.classList.add('scale-125', 'text-white');
            setTimeout(() => el.classList.remove('scale-125', 'text-white'), 200);
        }

        // --- SONUÇ ---
        function endGame() {
            const duration = stopTimer();
            const timeBonus = Math.max(0, (60 - duration) * 5);
            const totalScore = score + timeBonus;

            document.getElementById('resultPlayerName').innerText = currentPlayer;
            document.getElementById('finalScore').innerText = totalScore;
            
            const m = Math.floor(duration / 60).toString().padStart(2, '0');
            const s = (duration % 60).toString().padStart(2, '0');
            document.getElementById('finalTime').innerText = `${m}:${s}`;
            
            document.getElementById('finalPassword').innerText = currentPassword;

            saveScore({
                name: currentPlayer,
                score: totalScore,
                time: duration,
                level: currentLevel
            });

            playSound('win');
            fireConfetti();
            document.getElementById('resultModal').classList.remove('hidden');
        }

        function resetForNewStudent() {
            document.getElementById('resultModal').classList.add('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            
            const input = document.getElementById('studentName');
            input.value = "";
            input.focus();
        }

        // --- LİDERLİK TABLOSU ---
        function saveScore(data) {
            let scores = JSON.parse(localStorage.getItem('sifre_ustasi_scores_v3') || '[]');
            scores.push(data);
            scores.sort((a, b) => b.score - a.score);
            localStorage.setItem('sifre_ustasi_scores_v3', JSON.stringify(scores));
        }

        function showLeaderboard(filter) {
            document.getElementById('leaderboardModal').classList.remove('hidden');
            if(filter === 'current') filter = currentLevel;
            filterLeaderboard(filter);
        }

        function closeLeaderboard() {
            document.getElementById('leaderboardModal').classList.add('hidden');
        }

        function filterLeaderboard(filter) {
            document.querySelectorAll('.lb-filter').forEach(btn => {
                if(btn.innerText.toLowerCase().includes(filter === 'all' ? 'genel' : (filter === 'ai' ? 'yapay' : filter))) {
                    btn.className = "lb-filter px-4 py-1 rounded-full bg-blue-600 text-white text-xs font-bold transition scale-105";
                } else {
                    btn.className = "lb-filter px-4 py-1 rounded-full bg-slate-700 text-gray-400 text-xs font-bold transition hover:bg-slate-600";
                }
            });

            const list = document.getElementById('leaderboardList');
            list.innerHTML = '';
            
            let scores = JSON.parse(localStorage.getItem('sifre_ustasi_scores_v3') || '[]');
            
            if (filter !== 'all') {
                scores = scores.filter(s => s.level === filter);
            }
            
            scores.sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return a.time - b.time;
            });

            if (scores.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-8">Henüz kayıt yok.</div>';
                return;
            }

            scores.forEach((s, index) => {
                const m = Math.floor(s.time / 60).toString().padStart(2, '0');
                const sec = (s.time % 60).toString().padStart(2, '0');
                const isTop = index === 0;
                
                const div = document.createElement('div');
                div.className = `grid grid-cols-12 px-4 py-3 rounded-xl items-center text-sm mb-1 ${isTop ? 'bg-gradient-to-r from-yellow-900/40 to-slate-800 border border-yellow-500/30' : 'bg-slate-800 border border-slate-700'}`;
                
                div.innerHTML = `
                    <div class="col-span-1 font-bold ${isTop ? 'text-yellow-400 text-lg' : 'text-gray-500'}">${index + 1}</div>
                    <div class="col-span-5 font-bold text-white truncate flex items-center gap-2">
                        ${isTop ? '<i class="fas fa-crown text-yellow-500"></i>' : ''} ${s.name}
                    </div>
                    <div class="col-span-3 text-right font-mono font-bold text-blue-400">${s.score}</div>
                    <div class="col-span-3 text-right font-mono text-gray-400 text-xs">${m}:${sec}</div>
                `;
                list.appendChild(div);
            });
        }
        
        function clearLeaderboard() {
            if(confirm("Tüm sınıfın skorları silinecek. Onaylıyor musunuz?")) {
                localStorage.removeItem('sifre_ustasi_scores_v3');
                filterLeaderboard('all');
            }
        }

        // --- SES VE EFEKT ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (!soundEnabled || audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            
            if (type === 'correct') {
                osc.type = 'triangle'; osc.frequency.setValueAtTime(523, now); osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
                gain.gain.setValueAtTime(0.1, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
                osc.start(now); osc.stop(now + 0.3);
            } else if (type === 'error') {
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2);
                gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'win') {
                [523, 659, 784, 1046].forEach((f, i) => {
                    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination); o.type='square'; o.frequency.value=f;
                    g.gain.setValueAtTime(0.05, now+i*0.1); g.gain.linearRampToValueAtTime(0, now+i*0.1+0.2);
                    o.start(now+i*0.1); o.stop(now+i*0.1+0.2);
                });
            }
        }
        function toggleSound() { soundEnabled = !soundEnabled; document.getElementById('soundBtn').style.opacity = soundEnabled ? 1 : 0.5; }
        function fireConfetti() {
            const colors = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b'];
            for (let i = 0; i < 100; i++) {
                const c = document.createElement('div'); c.className = 'confetti';
                c.style.left = Math.random()*100+'vw'; c.style.top = -10+'px';
                c.style.background = colors[Math.floor(Math.random()*4)];
                c.style.animation = `fall ${Math.random()*3+2}s linear forwards`;
                document.body.appendChild(c); setTimeout(() => c.remove(), 5000);
            }
            const s = document.createElement('style'); s.innerHTML = `@keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }`;
            document.head.appendChild(s);
        }
    </script>
</body>
</html>
